  <sect1 id="installer_on_ios">
    <title>Installing generated configuration onto Cisco routers</title>

    <para>
      Firewall Builder 4.0 introduces two improvements in the
      built-in policy installer for Cisco routers: ability to
      install generated configuration using scp and support for
      Embedded Event Manager for automated rollback.
    </para>

    <sect2>
      <title>Installing configuration with scp</title>

      <para>
        Built-in installer in Firewall Builder v4.0 can use command
        <command>scp</command> to copy IOS configuration to the router
        using ssh and then command <command>"copy file
          running-config"</command> to activate it. This method is much
        faster than running configuration line by line. The router
        should be configured with ssh v2 and scp server. This method
        can be combined with rollback (by reload or EEM). To use this
        method, turn on checkbox in the tab
        <emphasis>"Installer"</emphasis> of the <emphasis>"advanced
          settings"</emphasis> dialog of the router object. Since this
        option is configured separately for each firewall object, you
        can have a mix of installation methods if some routers do not
        support <command>scp</command>.
      </para>

      <para>
        For instructions how to configure <command>scp</command> on IOS
        see <ulink url="http://www.cisco.com/en/US/docs/ios/12_2t/12_2t2/feature/guide/ftscp.html">Secure
          Copy</ulink>. You need to do the following:
      </para>

      <itemizedlist>
        <listitem>
          <para>
            Create RSA keys using the following commands:
          </para>
        </listitem>

        <listitem>
          <para>
            enable ssh v2 using command <command>"ip ssh version 2"</command>
          </para>
          <para>
            If you get an error message <command>"Please create RSA
            keys (of atleast 768 bits size) to enable SSH
            v2"</command> after this command, you probably need to
            configure ssh server to read the key you have generated by
            name using command <command>ip ssh rsa keypair-name
            key_name</command> as shown in the example below.
          </para>
        </listitem>

        <listitem>
          <para>
            enable scp server using command <command>"ip scp server enable"</command>.
          </para>
        </listitem>

        <listitem>
          <para>
            User account used to copy the policy should have privilege
            15: <command>"username vadim privilege 15 password 7 XXXXXXXXXXX"</command>.
          </para>
        </listitem>

        <listitem>
          <para>
            Set up authentication using <command>"aaa
            new-model"</command> command.
          </para>
        </listitem>

      </itemizedlist>

      <para>
        The whole sequence should look like this:
      </para>


      <programlisting>
router(config)#hostname router_host_name
router(config)#ip domain-name domain.com
router(config)#crypto key generate rsa
The name for the keys will be: router_host_name.domain.com
Choose the size of the key modulus in the range of 360 to 2048 for your
  General Purpose Keys. Choosing a key modulus greater than 512 may take
  a few minutes.

How many bits in the modulus [512]: 2048
% Generating 2048 bit RSA keys, keys will be non-exportable...[OK]

router(config)#ip ssh version 2   
Please create RSA keys (of atleast 768 bits size) to enable SSH v2.
router(config)#ip ssh rsa  keypair-name  router_host_name.domain.com
*May  2 12:09:20.155: %SSH-5-ENABLED: SSH 2.0 has been enabled
router(config)#ip scp server enable
router(config)#
router(config)#aaa new-model
router(config)#aaa authentication login default local
router(config)#aaa authorization exec default local
router(config)#username tiger privilege 15 password 0 enter_password_here
      </programlisting>

      <para>
        To generate the key and store it on specific device, use command:
        <programlisting>
crypto key generate rsa general-keys modulus  1024 storage  nvram:
        </programlisting>
      </para>

      <para>
        To troubleshoot when scp is not working:
      </para>

      <itemizedlist>
        <listitem>
          <para>
            Test using command line scp tool rather than fwbuilder
            installer. Use "scp" on Linux and Mac OS X and "pscp.exe"
            on Windows like this:<command> "scp file.fw router:nvram:file.fw"</command>
          </para>
        </listitem>

        <listitem>
          <para>
            check that <command>ssh</command>
            and <command>scp</command> are enabled on the router (see
            commands above)
          </para>
        </listitem>

        <listitem>
          <para>
            check that user account has privilege 15
          </para>
        </listitem>

        <listitem>
          <para>
            Use command <command>"debug ip ssh"</command> on the
            router to turn debugging on. Diagnostic messages that it
            prints to the console and to log may help you identify the
            problem
          </para>
        </listitem>
      </itemizedlist>
      
      <note>
        <para>
          Installer does not use command <command>"config
            replace"</command> because configuration created by
          fwbuilder is incomplete and should be merged with running
          config rather than replace it.
        </para>
      </note>

    </sect2>

    <sect2>
      <title>Rollback using EEM</title>

      <para>
        Built-in policy installer uses EEM (Embedded Event Manager) on
        IOS 12.4 or later to schedule automatic configuration rollback
        instead of reloading the router. EEM appears in IOS 12.4 and
        supports background operations that can be triggered by some
        events on the router or by timers. In this new feature,
        fwbuilder creates EEM applet with a countdown timer that
        executes command <command>"config replace nvram:startup-config
          force"</command> when timer expires. User has the following
        options:
      </para>

      <itemizedlist>
        <listitem>
          <para>
            Schedule automatic rollback in a few minutes and install
            updated ACL configuration. This can be used to test new
            policy and revert to the original one after some short
            period of time. This also helps to avoid a situation when
            updated policy blocks access to the router because of an
            error; rolling back to the ACL configuration that was
            running before the update will restore access
            automatically.
          </para>
        </listitem>

        <listitem>
          <para>
            Schedule rollback in a few minutes, install updated ACL
            but cancel rollback if installation of the new
            configuration was successful. This is mostly intended to
            prevent blocking access to the router in case of an error
            in the new ACL configuration. If fwbuilder was able to
            enter all lines of the new configuration all the way to
            the end, this means new configuration does not block
            access and installer executes command <command>"no event
              manager applet fwbuilder-rollback"</command> to cancel
            scheduled rollback.
          </para>
        </listitem>

        <listitem>
          <para>
            Since IOS before 12.4 does not have EEM, automatic
            rollback on these older versions is implemented by
            scheduling router reload with command <command>"reload in
              "</command>. This hasn't changed since Firewall Builder
            v3.0
          </para>
        </listitem>
      </itemizedlist>

    </sect2>

  </sect1>

