<?xml version="1.0"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
                 "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">

  <chapter id="Troubleshooting">
    <title>Troubleshooting</title>

    <para>This chapter provides tips for troubleshooting problems with the
    program.</para>

    <sect1 id="build_problems">
      <title>Build Issues</title>

      <sect2>
        <title>autogen.sh complains "libfwbuilder not installed"</title>

	<para><emphasis>When compiling from source, autogen.sh complains "libfwbuilder
        not installed"</emphasis></para>

        <para>As of version 0.9.6 the code has been split into three major
        parts: API, GUI and policy compilers. You need to download, compile
        and install API for the rest to compile. The API comes in a separate
        source archive called libfwbuilder-0.10.0.tar.gz. Compile and install
        it as usual, using "./autogen.sh; make; make install"
        procedure.</para>
      </sect2>

      <sect2>
        <title>"Failed dependencies: ..." when installing RPM</title>

	<para><emphasis>Trying to install fwbuilder RPM but I get a bunch of errors
        "Failed dependencies: ...". What do I need to do ?</emphasis></para>

        <para>You need to install prerequisite libraries. See the list of RPMs
        in the appendix.</para>

        <note><para>Do not use options "--force" or "--nodeps" when
        you install fwbuilder RPMs. If rpm complains about unsatisfied
        dependencies, this means your system is missing some libraries, or the
        wrong versions are installed. Forcing the package install won't fix
        that; most likely it will fail in one way or another.</para></note>
      </sect2>
    </sect1>

    <sect1 id="startup_problems">
      <title>Program Startup Issues</title>

      <sect2>
        <title>"fwbuilder: cannot connect to X server localhost:0.0"</title>

	<para><emphasis>fwbuilder binary does not start. Error "fwbuilder: cannot
        connect to X server localhost:0.0" or similar</emphasis></para>

        <para>Firewall Builder GUI is an X application, that is, it needs X
        server to display it on the screen. The program determines how to
        connect to the X server using environment variable DISPLAY; you
        probably do not have this environment variable if you get an error
        like that. The simplest way to avoid this problem is to start
        fwbuilder from the shell window in Gnome or KDE environment.</para>

        <para>It may also be that the environment variable DISPLAY is set, but
        the program fwbuilder cannot connect to the X server. In this
        situation you won't be able to run any application using X, check if
        that's the case by trying to start "xclock". This may be happening
        because of many different reasons, such as X server is not running, X
        authentication failure, or DISPLAY variable reassigned its value by
        the shell login script or many others. This problem falls outside the
        scope of this document, please search on the Internet for the answer.
        Here are few URLs to make troubleshooting easier:</para>

        <para><itemizedlist spacing="compact">
            <listitem>
              <para>http://www.openssh.org/faq.html</para>
            </listitem>

            <listitem>
              <para>http://en.tldp.org/HOWTO/XDMCP-HOWTO/ssh.html</para>
            </listitem>

            <listitem>
              <para>http://en.tldp.org/LDP/intro-linux/html/sect_10_03.html</para>
            </listitem>
          </itemizedlist></para>
      </sect2>

      <sect2>
        <title>"fwbuilder: error while
        loading shared libraries: libfwbuilder.so.0: cannot load shared
        object file: no such file or directory."</title>

	<para><emphasis>fwbuilder binary does not start. Error "fwbuilder: error while
        loading shared libraries: libfwbuilder.so.0: cannot load shared
        object file: no such file or directory."</emphasis></para>

        <para>Then the GUI binary (fwbuilder) cannot find API library
        libfwbuilder. If you are using our binary packages, then make sure you
        download and install package called libfwbuilder. If you compiled from
        sources, then perhaps you installed libfwbuilder with default prefix
        /usr/local/, therefore library went to /usr/local/lib. Dynamic linker
        ldd cannot find it there.</para>

        <para>You have the following options:</para>

        <para><itemizedlist spacing="compact">
            <listitem>
              <para>create environment variable LD_LIBRARY_PATH with value
              /usr/local/lib and run fwbuilder from this environment.</para>
            </listitem>

            <listitem>
              <para>add /usr/local/lib to the file /etc/ld.so.conf and run
              ldconfig so it will rescan dynamic libraries and add them to its
              cache.</para>
            </listitem>

            <listitem>
              <para>recompile libfwbuilder and fwbuilder with prefix /usr/,
              this will install libfwbuilder.so.0 in /usr/lib. ldd will find
              it there without any changes to environment variables or
              /etc/ld.so.conf file. To change prefix you need to run
              autogen.sh with command line parameter "--prefix=/usr". Do this
              both for libfwbuilder and fwbuilder.</para>
            </listitem>
          </itemizedlist></para>
      </sect2>

      <sect2>
	<title>"fwbuilder: error while loading shared libraries: /usr/local/lib/libfwbuilder.so.8: cannot restore segment prot after reloc: Permission denied"</title>

	<para><emphasis>fwbuilder binary does not start. Error "fwbuilder: error while loading shared libraries: /usr/local/lib/libfwbuilder.so.8: cannot restore segment prot after reloc: Permission denied"</emphasis></para>

	  <para>The problem is caused by SELinux security settings, to work around it try the following command:</para>

	  <para><command>chcon -t texrel_shlib_t /usr/lib/libfwbuilder.so*</command></para>
	</sect2>         
    </sect1>
    <sect1 id="troubleshooting-compiler-runtime">
      <title>Firewall Compiler and Other Runtime Issues</title>
      <sect2>
	<title>Firewall Builder crashes</title>

	<para><emphasis>Firewall Builder or policy compiler crashes</emphasis></para>

	<para>Please file a bug on Sourceforge. Provide information we might need to fix the problem. See the <ulink url="http://www.fwbuilder.org/contact.html"><citetitle>Firewall Builder Contact</citetitle></ulink> page for links to bug tracking and instructions for filing bugs.</para>
	</sect2>
	<sect2>
	  <title>Older data file cannot be loaded in Firewall Builder</title>

	<para><emphasis>Data file created in the older version of fwbuilder cannot be loaded in the latest one</emphasis></para>

	  <para>Sometimes this happens when you skip several versions trying to upgrade the program. There used to be a bug in the upgrade procedure somewhere around version 1.0.4 which broke automatic upgrades from versions before 1.0.4 to versions after that. If this happens to you, upgrade your data file using script fwb-upgrade.sh that you can find in Contrib/Scripts area on our SourceForge site.</para>
	</sect2>
      <sect2>
	<title>"I/O Error" while compiling policy. No other error.</title>

	<para><emphasis>"I/O Error" while compiling policy. There is no other indication of error though.</emphasis></para>

	<para>Did you install package with corresponding compiler ? Our pre-built compilers come in a separate RPMs named like this: fwbuilder-ipt-2.0.2-1rh9.i386.rpm</para>

	<para>Check if compiler dumped core. If you can't find it, you may try to run compiler manually, providing the following command line parameters:</para>

	<para><command>$ fwb_ipt  -f path_to_objects.xml   firewall_object_name</command></para> 
	<para>All policy compilers have the same command line format.</para>
      </sect2>
      <sect2>
	<title>ios_base::failbit set on Windows</title>

	<para><emphasis>Policy compiler stops with an error
	ios_base::failbit set on Windows</emphasis></para>

	<para>It looks something like this:</para>
	<screen>
---------------------------------------
fwb_ipfw -f C:/Documents and Settings/User/data.fwb -d C:/Documents
and Settings/User -r C:\FWBuilder\resources fw

 Compiling policy for fw ...
  Detecting rule shadowing
 Begin processing
 Policy compiled successfully 
ios_base::failbit set
------------------------------------------
        </screen>

	<para>First of all, check available free disk space. Also
	check if the output file ( fw.fw ) is opened in another
	program while compiler is running. That is, if you looked at
	it after the previous compiler run and opened it in Notepad,
	it becomes locked and compiler won't be able to overwrite it
	with the new copy until you close Notepad.</para>
      </sect2>

      <sect2>
	<title>"Cannot create virtual address NN.NN.NN.NN"</title>

	<para><emphasis>Policy compiler stops processing rules with
	error message "Cannot create virtual address
	NN.NN.NN.NN"</emphasis></para>

	<para>This happens when you are using an option "Create
	virtual addresses for NAT rules". The problem is that policy
	compiler needs to be able to determine interface of the
	firewall to assign virtual address to. In order to do that it
	scans all interfaces trying to find subnet requested NAT
	address is on. Sometimes firewall's interface has an address
	which belongs to a different network than NAT address
	specified in the rule; in this case compiler cannot identify
	an interface and aborts.</para>

	<para>The NAT rule still can be built without "-i" or "-o"
	option, but automatic assignment of virtual address is
	impossible. You need to turn off option "Create virtual
	addresses for NAT rules" in the tab "Firewall" of firewall
	dialog and configure this address manually. </para>
      </sect2>
    </sect1>


    <sect1 id="running_firewall_script">
      <title>Running the Firewall Script</title>
      <sect2>
	<title>Determining which rule caused an error</title>

	<para><emphasis>I get some error when I run generated script, how can I figure out which rule causes this error?</emphasis></para>

	<para>You can turn debugging on (look for a checkbox in the tab "Firewall" in firewall dialog). This simple generates firewall script with shell option "-x" so it will print all commands while executing. This way you can see which command causes the error and trace it back to the policy rule.</para>
      </sect2>
      <sect2>
	<title>"ip: command not found"</title>

	<para><emphasis> (Linux / iptables only) I've generated script for iptables firewall using Firewall Builder, but when I run it I get an error "ip: command not found". What is this command for and what package should I install?</emphasis></para>

	<para>This tool is part of the package 'iproute'; we use it to manage virtual IP addresses needed for some NAT rules.</para>
      </sect2>
      <sect2>
	<title> I get the following error when I run generated script for iptables firewall: "iptables v1.2.8: can't initialize iptables table 'drop': Table does not exits (do you need to insmod?) Perhaps iptables or your kernel needs to be upgraded."</title>

	<para>You get this error because you used option "Log all dropped packets" (there is a checkbox in the 'Firewall' tab). This option requires "dropped" patch from patch-o-matic. You either need to turn this option off, or apply corresponding patch and recompile both kernel modules and command-line utilities for iptables.</para>
      </sect2>
      <sect2>
	<title>"Interface eth0 does not exist"</title>

	<para><emphasis>You are trying to execute iptables script generated by fwbuilder but get an error message "Interface eth0 does not exist" or similar.</emphasis></para>

	<para>There are several conditions that may cause this error.</para>

	<para>The script generated by fwbuilder uses tool /sbin/ip to verify configuration of the firewall interfaces and make sure that interfaces of the real firewall machine correspond to the interface objects created in the GUI. You may get this error if the tool /sbin/ip is not installed on your system. All modern Linux distributions come with the package iproute2 which includes /sbin/ip; check if iproute2 is installed and /sbin/ip exists.</para>

	<para>Another case when you may encounter this error is when firewall script is executed prematurely during the boot sequence and interface really does not exist at that time. For example, interface ppp0 is created only when the system is configured for PPP and daemon pppd is running. If firewall script is activated before the daemon started during the boot sequence, interface ppp0 is not there yet, which leads to this error. Make sure you start firewall script after all interfaces has been initialized.</para>
      </sect2>
      <sect2>
	<title>"Interface eth0:1 does not exist"</title>

	<para><emphasis>My firewall has virtual interface eth0:1. In fwbuilder I added the interface, however, when I want to apply the new rules I get the error "Interface eth0:1 does not exist"</emphasis></para>

	<para>eth0:1 is not a real interface on Linux, it is just a label for a second IP address of the interface eth0. One way to solve this is not to create it in the OS (remove file /etc/sysconfig/network-scripts/ifcfg-eth0:1 and restart networking), but rather add its IP address in the Firewall Builder GUI as a second address to interface eth0.</para>

	<para>In any case you should not add interface "eth0:1" in fwbuilder because it really does not exist. Iptables will not recognize this interface either, so even if fwbuilder let you use it, you would get an error from iptables. You see "eth0:1" in the output of ifconfig only because ifconfig has been modified on Linux to show virtual IP addresses as pseudo-interfaces. The command "ip addr show" will reveal that the eth0:1 is really a label on the second IP address of eth0.</para>
      </sect2>
      <sect2>
	<title>Script fails to load module nf_conntrack</title>

	<para><emphasis>Generated script fails to load module nf_conntrack when it is executed on the firewall</emphasis></para>
	<para>This problem is specific to iptables. The answer below has been written in September 2006, most likely the situation and relevant recommendations are going to change in the future as module nf_conntrack matures and gets wider deployment.</para>

	<para>Here is an example of an error message:</para>
	<screen>
FATAL: Error inserting nf_conntrack_ipv4
(/lib/modules/2.6.13-15.11-default/kernel/net/ipv4/netfilter/nf_conntrack_ipv4.ko):
Device or resource busy
        </screen>

	<para>Here is the <ulink url="http://www.netfilter.org/projects/patch-o-matic/pom-extra.html#pom-extra-nf_conntrack"><citetitle>link</citetitle></ulink> to the nf_conntrack page in patch-o-matic catalog. Here is the <ulink url="http://lists.netfilter.org/pipermail/netfilter-devel/2006-July/024879.html"><citetitle>link</citetitle></ulink> to the discussion on netfilter-devel mailing list.</para>

	<para>It appears you can load either ip_conntrack or nf_conntrack but not both at the same time since nf_conntrack is a replacement for ip_conntrack. As of this writing, nf_conntrack does not support NAT just yet and is marked as having status "TESTING" on the patch-o-matic catalog page.</para>

	<para>This actually represent a problem for fwbuilder. I would like to avoid having to write extensive GUI to let user choose which modules they want to load. One of the reasons is that the GUI may be working on one machine, while generated firewall script will be executed on another. In this situation the GUI cannot determine which modules are available on the firewall. Currently generated script simply tries to load all modules but it aborts if it detects an error in the command that does it (modprobe).</para>

	<para>Until better solution is found, you would probably need to remove module that conflicts with others or disable feature that makes generated script load modules and write your own script to load modules you need. You can for example add commands to load modules explicitly to the "prolog" section of the generated script.</para>
      </sect2>
    </sect1>
 <!-- ############################################################### -->
    <sect1 id="policy-importer">
      <title>Using Built-in Policy Importer in Firewall Builder</title>

          <para>
  
                  There are two ways to activate the feature: Main
                  menu <guimenuitem>File/Import Policy</guimenuitem> or
                  <guimenuitem>Tools/Discovery Druid</guimenuitem> and then
                  choose option <guilabel>Import configuration of a
                  firewall or a router</guilabel>.  Only the import of
                  iptables and Cisco IOS access lists is possible in
                  the current version.
                
          </para>
  

      <sect2>
        <title>Importing existing iptables configuration</title>
          <para>
  
                  Firewall Builder imports iptables configs in
                  the format of iptables-save. Script <command>iptables-save</command> is part
                  of the standard iptables install and should be
                  present on all Linux distribution. Usually this
                  script is installed in <emphasis>/sbin/</emphasis> . When you run
                  this script, it dumps the current iptables configuration
                  to stdout. It reads iptables rules directly form the
                  kernel rather than from some file, so what it dumps
                  is what is really working right now. To import this
                  into Firewall Builder, run the script to save the configuration
                  to a file:
                
          </para>
  
  <screen>
iptables-save &gt; iptables_config.conf
                </screen>

          <para>
  
                  Then launch Firewall Builder, activate the <guimenuitem>Import
                  Policy</guimenuitem> function and click <guibutton>Browse</guibutton> to find <filename>iptables_config.conf</filename>. You also
                  need to choose <guimenuitem>iptables</guimenuitem> in the <guilabel>Platform</guilabel> pull-down
                  menu.
                
          </para>
  

          <para>
  
                  If you do not choose "iptables" in 
                  <guilabel>Platform</guilabel>, the program will try to
                  interpret the file using a different parser and will
                  fail. The program does not make any assumptions
                  about the file name or extension and cannot predict
                 the source platform of the configuration.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_1.png"/></figure>

	<sect3>
        <title>Importing an iptables configuration created in FireStarter</title>

          <para>
  
                  The following example demonstrates an import of an
                  iptables policy generated by <emphasis>Firestarter</emphasis>,
                  another popular iptables configuration management
                  program.
                
          </para>
  

          <para>
  
                  After the platform is selected and file name
                  entered, click <guibutton>Next</guibutton> to start the process.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_2.png"/></figure>

          <para>
  
                  The program tries to interpret the configuration file
                  rule-by-rule and recreates its equivalent in
                  Firewall Builder. The progress window displays errors, if
                  any, as well as some diagnostics that shows network
                  and service objects created in the process. Note
                  that user-defined iptables chains found in the
                  configuration file will be re-created in Firewall Builder
                  as policy rule sets. The screenshot shows rulesets
                  "LSI", "LSO", "OUTBOUND" being created. (There were
                  more but they did not fit in the output
                  window.) Address objects "h-10.3.14.10",
                  "h-10.3.14.255" and few others have been created as
                  well. Service objects "tcp fsra/s", "udp 0-0:0-0",
                  "icmp -1/-1" and few others have also been created.
                
          </para>
  

          <para>
  
                  Note that the new firewall object created in the
                  process has generic name "New Firewall". This is
                  because iptables configuration file used for import
                  does not have information about firewall machine
                  name. It also does not have information about its
                  interfaces, their names and addresses. The program
                  can infer their names when it encounters
                  "-i &lt;interface&gt;" or "-o &lt;interface&gt;" clauses in the
                  iptables configuration lines. It cannot reliably
                  detect their addresses though. You need to manually rename the
                  firewall object and add IP addresses to interfaces
                  after the import.
                
          </para>
  

          <para>
  
                  Note also that only the IPv4 part of the iptables
                  configuration was imported. Currently, import of
                  IPv6 iptables configuration is not supported.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_3.png"/></figure>

          <para>
  
                  Screenshot above shows rule sets that the
                  program created from the configuration it
                  imported. Rule sets "INBOUND", "LOG_FILTER", "LSI",
                  "LSO", "OUTBOUND", "Policy" are all of the type
                  "Policy" and contain filtering rules. There were no
                  NAT rules in the original configuration so the rule
                  set "NAT" is created but is empty. The names of all
                  policy rule sets match names of the iptables chains
                  in the original configuration.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_7.png"/></figure>

        <figure float="1"><title/><graphic scale="50" fileref="importer_8.png"/></figure>

        <figure float="1"><title/><graphic scale="50" fileref="importer_9.png"/></figure>

          <para>
  
                  Screen shots above demonstrate address and service
                  objects created by the program. The importer writes a comment
                  in each object to remind you that the object was created
                  automatically on import. Names of these objects are
                  chosen automatically, but you can rename objects to give
                  them more meaningful names. Some of the objects
                  created during import have the same properties as
                  existing service and address objects from the
                  Standard objects library. Currently the program does
                  not cross-match them and just creates new objects,
                  however in the future it may use Standard objects
                  instead.
                
          </para>
  

          <para>
  
                Some rules in the original iptables config used
                "--tcp-flags" parameter to match only certain
                combinations of tcp flags. Here is an example:
              
          </para>
  

  <screen>
-A INPUT -s 10.3.14.10 -p tcp -m tcp ! --tcp-flags FIN,SYN,RST,ACK SYN -j ACCEPT 
              </screen>

          <para>
  
                In order to be able to reproduce this rule, Firewall Builder
                created a special TCP service object with given
                combination of tcp mask and flags:
              
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_10.png"/></figure>

          <para>
  
                  The following screenshot shows rules created
                  in the main Policy rule set. These are the top
                  iptables rules, though some of them branch off to the other
                  Policy rule sets. Some of the rules in the original
                  policy did not match state (did not have clause "-m
                  state --state NEW" or similar), these rules were
                  created with the flag "stateless" turned on. In
                  Firewall Builder, this makes the policy compiler generate
                  iptables commands without a "-m state --state NEW"
                  clause that matches the original.  These rules are
                  marked with an icon that represents non-default rule
                  options in the column <guilabel>Options</guilabel>.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_14.png"/></figure>

          <para>
  
                  Let's inspect one group of rules a little closer. The
                  original iptables file contained the following
                  commands:
                
          </para>
  

  <screen>

-A INPUT -i eth0 -j INBOUND 


-A INBOUND -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A INBOUND -p udp -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A INBOUND -s 10.3.14.0/255.255.255.0 -j ACCEPT 
-A INBOUND -s 10.3.14.0/255.255.255.0 -p tcp -m tcp --dport 22 -j ACCEPT 
-A INBOUND -s 10.3.14.0/255.255.255.0 -p udp -m udp --dport 22 -j ACCEPT 
-A INBOUND -j LSI 

                </screen>

          <para>
  
                  The first rule is in chain INPUT and was recreated
                  as rule #11 in the Policy rule set (rule colored
                  green). Since it was in INPUT, the destination
                  object in the rule #11 is the firewall itself. The
                  "-i eth0" clause translated into interface object
                  "eth0" in the "Interface" rule element and direction
                  "Inbound". The action of the rule #11 is "Branch",
                  pointing to the rule set "INBOUND". This is direct
                  re-creation of the original rule in the iptables config.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_15.png"/></figure>

          <para>
  
                  This screenshot demonstrates rules created in the
                  rule set "INBOUND". Rule #0 matches CustomService
                  object "custo-0-tcp" that was created to match a 
                  combination of protocol "tcp" and state
                  "RELATED,ESTABLISHED". This object is shown in the
                  following screenshot:
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_11.png"/></figure>

          <para>
  
                  Firewall Builder automatically adds a rule on top of the 
                  generated iptables script to match packets in states
                  "ESTABLISHED, RELATED". With that rule, it is not
                  necessary to have a rule like #0 in INBOUND, but
                  since the original script had it, Firewall Builder reproduced
                  it.
                
          </para>
  

          <para>
  
                  Rule #1 in INBOUND matches protocol UDP and state
                  "ESTABLISHED,RELATED". Other rules in INBOUND
                  reproduce original rules from the chain INBOUND and
                  match packets coming from the local net heading for
                  the firewall machine. It is easy to see that the
                  original policy was redundant: rules #2-4 match the
                  same source and destination addresses but different
                  services, but rule #2 matches any service which
                  means rules #3 and 4 will never match any
                  packets. Fwbuilder will detect this problem
                  automatically if you try to compile this policy
                  (this is called "Rule shadowing").
                
          </para>
  

          <para>
  
                  All packets not matched by any rule in INBOUND will
                  match the last rule in this rule set, which branches to
                  the rule set LSI. Rule set LSI logs various packets
                  and drops them:
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_16.png"/></figure>

          <para>
  
                  You might wonder why we have all these rules
                  with action "Continue".
                
          </para>
  

          <para>
  
                  When a rule is marked as "logging" in Firewall Builder, it
                  gets an icon in the column "Options" that represents
                  logging. This icon appears either by itself or next to
                  the icon that represents non-default rule
                  options. However, iptables does not allow for an
                  action "Accept" or "Deny" to be used in combination
                  with logging. In iptables, logging is a separate target
                  just like "ACCEPT" or "DROP". Because of that,
                  Firewall Builder splits a rule that has action "Accept" or
                  "Deny" or any other with logging turned on. One such
                  rule becomes two or more iptables rules in the
                  generated script. Unfortunately when iptables script
                  is imported back, the program cannot merge such
                  rules and logging rules appear in the rule set as
                  separate rules with a logging icon in the "Options"
                  column and action "Continue". This is a valid
                  configuration in Firewall Builder, it just means that the
                  rule generates a log record but does not make any
                  decision whether the packet should be accepted or
                  denied.
                
          </para>
  

          <para>
  
                  Here is the fragment of the original iptables rules in
                  the chain LSI:
                
          </para>
  

  <screen>
-A LSI -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN \
    -m limit --limit 1/sec -j LOG --log-prefix "Inbound " --log-level 6 
-A LSI -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j DROP 
                </screen>

          <para>
  
                  These rules become rules #1 and 2 in rule set LSI in
                  Firewall Builder. The first rule, the one that does
                  logging, becomes a separate rule because this is how
                  it is done in iptables. If this policy was created
                  in Firewall Builder, rules #1 and 2 would be just one rule
                  in the GUI.  Double-clicking in the column <guilabel>Options</guilabel>
                  in rule #1 opens a dialog where you can inspect and
                  edit its options. The <guilabel>Limit</guilabel> tab in this dialog
                  controls parameters in the iptables "limit" module, which
                  was used in the original rule. Screenshot below
                  demonstrates how the policy importer recognized these
                  parameters and reproduced them in the rule options:
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_17.png"/></figure>

      </sect3>

      <sect3>
        <title>Limitations</title>

          <para>
  
                  The iptables policy importer in Firewall Builder has its
                  limitations. The main limitation is that it can only
                  parse certain set of iptables modules and
                  targets. There are too many modules and associated
                  targets out there and supporting all of them is next
                  to impossible. However, it supports the core
                  functionality and most popular modules. Even though the 
                  importer tries to match the original
                  configuration as closely as possible, you should always review the 
                  rules and objects it creates and edit resulting
                  rules. Most of the time rules can be simplified,
                  such as with logging rules as was explained
                  above. Often you can merge multiple rules by putting
                  several objects in a <guilabel>Source</guilabel> or <guilabel>Destination</guilabel> or
                  <guilabel>Service</guilabel> field. Using Object and Service groups is another
                  good way to simplify rules.
                
          </para>
  
	</sect3>
      </sect2>

      <sect2>
        <title>Importing Cisco IOS access lists configuration</title>

          <para>
  
                  Importing an IOS access lists configuration is more
                  straightforward because branching is not possible
                  there. To import a configuration, first you need to
                  save it using the <command>show run</command> command. IOS has literally
                  hundreds of different commands and configuration
                  clauses, but Firewall Builder can only parse those related
                  to the access lists configuration. Other commands
                  will be ignored. There is no need to edit the 
                  configuration prior to importing it into Firewall Builder
                  (except for the "banner" command, see below). </para>

	  <para>A saved
                  IOS configuration has information about the router's name
                  and its interfaces. This information will be used to
                  recreate objects in Firewall Builder. Parser will not only
                  create interface objects with proper names, it will
                  also attach address objects to them to describe
                  their IP addresses.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_20.png"/></figure>

          <para>
  
                  As with iptables, we start with
                  <guimenuitem>File/Import Policy</guimenuitem> and enter the filename in
                  the dialog. The <guilabel>Platform</guilabel> pull-down menu
                  should be set to <guimenuitem>Cisco IOS</guimenuitem>. Click <guibutton>Next</guibutton> to
                  start the import process.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_21.png"/></figure>

          <para>
  
                  The program recognized router name "c3620" and its
                  interfaces, created interface objects with their IP
                  addresses and then created some address and service
                  objects. This test router config contains the
                  following lines (this is just a fragment, there are
                  more interfaces and more ACLs):
                
          </para>
  

  <screen>

interface FastEthernet0/0
 ip address 192.168.100.100 255.255.255.0 secondary
 ip address 10.3.14.201 255.255.255.0
 ip access-group fe0_0_acl_in in
 ip access-group fe0_0_acl_out out
 no ip mroute-cache
 duplex auto
 speed auto
!
interface Ethernet1/0
 description Test [test] {test} (and one more test) /weird:characters#$%^&amp;*/
 ip address 192.168.171.2 255.255.255.0
 ip access-group e1_0_acl_in in
 ip access-group e1_0_acl_out out
 no ip mroute-cache
 ip ospf cost 65000
 half-duplex
 crypto map real


!################################################################
ip access-list extended e1_0_acl_in
 deny   ip any any fragments
 permit tcp host 10.3.14.40 host 192.168.171.2 eq 22 log
 permit tcp host 10.3.14.40 host 10.3.14.201 eq 22 log
 permit ip any 10.3.14.0 0.0.0.255 log
 deny   ip any any log
!################################################################
ip access-list extended e1_0_acl_out
 permit ip 10.3.14.0 0.0.0.255 any log
 deny   ip any any log

                </screen>

          <para>
  
                  The parser recognizes comments and skips them, but text
                  from interface descriptions goes into comments in
                  the Interface objects.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_22.png"/></figure>

          <para>
  
                  Firewall Builder recognizes both named and regular
                  extended access lists. Each separate access list is
                  recreated in Firewall Builder in the same main Policy rule
                  set. The program recognizes "ip access-group"
                  commands and puts the corresponding interface object in
                  the "Interface" rule element of the rules it
                  creates.
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_30.png"/></figure>

          <para>
  
                  The original configuration used the same access list
                  "133" with two interfaces:
                
          </para>
  

  <screen>

interface Ethernet1/1
 ip address 10.10.10.10 255.255.255.0
 no ip mroute-cache
!
!  Note - the same access list applied both in and out
 ip access-group 133 in
 ip access-group 133 out
 no shutdown
 half-duplex
!
interface Ethernet1/2
 ip address 10.10.20.20 255.255.255.0
 no ip mroute-cache
!
!  Note - the same access list applied both in and out
!  the same list is applied to eth 1/1 and eth 1/2
 ip access-group 133 in
 ip access-group 133 out
 no shutdown
 half-duplex
!
                </screen>

          <para>
  
                  The program recognizes this and creates object group
                  "intf-acl_133" with these two interfaces as members:
                
          </para>
  

        <figure float="1"><title/><graphic scale="50" fileref="importer_31.png"/></figure>

          <para>
  
                  It then uses this group in the <guilabel>Interface</guilabel> element
                  of rules #0, 1 and 2 to reproduce rules from the
                  access list "133".
                
          </para>
  

          <para>
  
                  Interface configuration commands visible in the
                  config snippets above, such as "half-duplex",
                  "duplex auto", "speed auto", various protocol
                  configuration commands and other commands supported
                  by IOS inside the "interface" block are ignored.
                
          </para>
  
	<sect3>
        <title>Limitations</title>

          <para>
  
                  One IOS configuration construct that Firewall Builder can
                  not import is the "banner" command. This command is
                  special in that it allows you to set an arbitrary
                  terminator character, and then it allows any text up
                  to this character. This creates a problem for the
                  Firewall Builder parser because the terminator character
                  can be arbitrary. You need to edit and remove banner
                  from the saved configuration file before importing
                  it.
                
          </para>
	</sect3>
      </sect2>
    </sect1>
 <!-- ############################################################### -->
    <sect1 id="rcs-troubleshooting">
      <title>RCS Troubleshooting</title>
      <sect2>
	<title>Error adding file to RCS</title>

	  <para><emphasis>Error adding file to RCS: Fatal error during initial RCS checkin of file</emphasis></para>

	  <para>You will get this error if you do not have RCS set up on your system. To resolve it, install and configure RCS on the workstation running Firewall Builder.</para>
      </sect2>
      <sect2>
	<title>"Error checking file out: co: RCS file c:/fwbuilder/RCS/file.fwb is in use"</title>

	<para><emphasis>I cannot open my data file, I get error "Error checking file out: co: RCS file c:/fwbuilder/RCS/file.fwb is in use"</emphasis></para>

	<para>A catastrophe (e.g. a system crash) can cause RCS to leave behind a semaphore file that causes later invocations of RCS to claim that the RCS file is in use. To fix this, remove the semaphore file. A semaphore file name typically begins with , or ends with _.</para>

	<para>If not that, then it could be another manifestation of bug #1908351</para>

	<para>See if there is a file with the name starting and ending with a comma in the RCS directory (like ",file.fwb,"). The file should have length of zero bytes. This file is a lock file, it is created and deleted by RCS tools. Bug 1908351 caused this lock file to be left behind. When that happens, ci won't check file in because it thinks another copy of ci is already running. Likewise, co won't check the file out for the same reason. If such file exists (zero bytes in length and name starting or ending with a comma), just delete it and try to check your data file out again.</para>
      </sect2>
      <sect2>
	<title>"Error checking file out:"</title>
	<para><emphasis>I cannot open my data file, I get error "Error checking file out:"</emphasis></para>

	<para>Such non-descriptive error message is usually caused by hard unrecoverable errors experienced by RCS tools. Unfortunately these tools not always report errors in the best way possible and when this happens, Firewall Builder GUI cannot provide any better diagnostics than it gets from the tool. Such poor diagnostics of errors happens more frequently on Windows than on other platforms.</para>

	<para>Here are few things to check and try:</para>
	<itemizedlist>
	  <listitem><para>First of all, check file permissions. The data file (.fwb) should be read-only. RCS repository file (.fwb,v) should also be read-only. Repository file may be located in subdirectory RCS but that depends on the OS. It may be located in the same directory with corresponding data file (.fwb) as well.</para></listitem>
	  <listitem><para>Try to check the file out manually to see if you can get better diagnostics:</para>
	  <para>If you use Windows, start MS DOS window and in it navigate to the folder where you keep your files, then execute the following command:</para>
	  <screen>c:\FWBuilder\co.exe -l filename.fwb</screen>
	  <para>If it checks the file out successfully, it just prints revision number and 'done'. Otherwise it will print some error.</para>
	  <para>After you do that, you need to check the file in to RCS again. Do it like this:</para>
	  <screen>c:\FWBuilder\ci.exe -u filename.fwb</screen>
	  <para>Since the file hasn't changed, it should just check it in without asking you for the RCS log record. If you can successfully check it out and then check it in again from the command line, then the GUI should work too.</para>
	  <para>On Linux, *BSD and Mac OS X the process is exactly the same, except for the path to the checkout and checkin commands:</para>

	  <para>To check the file out use</para>
	  <screen>co -l filename.fwb</screen>
	  <para>
      To check the file in use
	  </para>
	  <screen>ci -u filename.fwb</screen>
	  </listitem>
	</itemizedlist>
      </sect2>
    </sect1>


    <sect1 id="problems_after_policy_activation">
      <title>Issues after new policy activation</title>

      <sect2>
        <title>Cannot access only some web sites</title>

	<para><emphasis>Can access most web sites through the firewall just fine,
        except for a few.</emphasis></para>

        <para>The browser would state "waiting for www.somesite.com" for a
        while and then time out when you connect to one of these sites.</para>

        <para>This might be caused by a MTU problem if you are on a DSL
        connection using PPPoE. Here are couple of useful pages that describe
        the problem in details:</para>

        <para><itemizedlist spacing="compact">
            <listitem>
              <para>http://www.dslreports.com/tweaks/MTU</para>
            </listitem>

            <listitem>
              <para>http://www.internetweekly.org/llarrow/mtumss.html</para>
            </listitem>
          </itemizedlist></para>

        <para>If your firewall runs iptables you can use option "Clamp MSS to
        MTU" in the firewall settings dialog to work around it.</para>

        <para>For the PF firewalls similar option is called "Enforce maximum
        MSS" and is located in the "Scrub rule options" tab of firewall
        settings dialog. It allows for setting MSS value of TCP sessions
        opened through the firewall; try values between 1460 or 1464 (1464 is
        the maximum MSS value that can be used on PPPoE connections without
        fragmentation).</para>

        <para>There is no way to change MSS value on the ipf, ipfw and pix
        firewalls. If your firewall is one of these, you may need to change
        MTU on your workstation. See links above for recommendations on how to
        do it.</para>
      </sect2>

      <sect2>
	<title>Firewall becomes very slow with new policy</title>

	<para>You compiled and started firewall policy script and then
	noticed that seemingly every operation on the firewall takes a
	lot longer than before. For example, it takes forever to log
	into it using telnet or ssh, different services take a few
	minutes to start or won't start at all.</para>

	<para>Most likely the firewall needs to be able to do DNS
	lookups but can't. Look in /etc/resolv.conf for the address of
	the name server it is using and make sure you have a rule in
	the policy to permit connections to it. Use firewall object in
	"Source", the name server object in "Destination" and a
	standard service object group "DNS" in the Service
	field.</para>

	<para>If your firewall runs caching name server and file
	/etc/resolv.conf lists "127.0.0.1" as a name server address,
	then you need to permit firewall to talk to itself. Here is
	how such /etc/resolv.conf file looks like:</para>

<screen>
    domain your_domain.com
    nameserver 127.0.0.1 
</screen>

	<para>You need to add a rule with the firewall object in both
	Source and Destination fields and the service object group
	"DNS" in the Service field to the loopback interface. This
	rule permits the firewall machine to communicate with the name
	server running on it, but you need another rule to permit the
	name server to send DNS queries and receive answers. This rule
	should have the firewall object in Source, Destination should
	be set to "any" and the same standard service object group
	"DNS" should be used in the Service element. Now not only
	firewall can query the name server process running on it, but
	the process in turn can send queries to other name servers on
	the Internet and receive answers.</para>

	<para>Here is the rule that should be added to the loopback
	interface:</para>

      <figure float="1" id="dns1">
        <title>DNS on loopback</title>
            <graphic scale="70" fileref="dns1.png" />
      </figure>

	<para>Here is the rule that permits the name server process to
	communicate with name servers on the Internet:</para>

      <figure float="1" id="dns2">
        <title>DNS on to name servers</title>
            <graphic scale="70" fileref="dns2.png" />
      </figure>

	<para> Depending on your policy design, you may want to permit
	all services rather than just DNS on the loopback interface
	because there are many other processes that need to be able to
	communicate with the same host, such as X11, RPC and
	others. The dedicated firewall machine should not run anything
	unnecessary, so there you may experiment with limiting the
	number of services in the rule on loopback the interface. On
	the other hand, if you use fwbuilder to protect a server that
	runs many different services, permitting any service on the
	loopback may be a simpler solution.</para>

	<para>The next rule permits processes running on the firewall
	to communicate with other processes running on the same
	machine on all protocols:
        </para>
        
        <figure id="dns3">
          <title>Any to any on firewall</title>
          <graphic scale="70" fileref="dns3.png" />
        </figure>

      <para>
        
      </para>

      </sect2>

      <sect2>
	<title>X won't start on a server protected by the firewall</title>

	<para>You've built a firewall script to protect a server, but after you ran the script, X (KDE, Gnome) won't start anymore.</para>

	<para>The reason for this is the same as in the DNS problem&mdash;you need a rule to permit processes to communicate with other processes running on the same machine. This can easily be achieved with the following rule added to the loopback interface:</para>

      <figure id="dns3-1">
        <title>Any to any on firewall</title>
            <graphic scale="70" fileref="dns3.png" />
      </figure>

      </sect2>

      <sect2>
        <title>Cannot access Internet from behind firewall</title>

	<para><emphasis>I compiled and activated firewall policy, but workstations
        behind the firewall still cannot access the Internet.</emphasis></para>

        <para>Here are few troubleshooting steps:</para>

        <para><itemizedlist spacing="compact">
            <listitem>
              <para>Make sure you compiled, then installed and activated
              firewall policy. Were there any errors during compile and
              activation?</para>
            </listitem>

            <listitem>
              <para>check if ip forwarding is turned on (pull down menu in the
              "Network" tab of the firewall object dialog).</para>
            </listitem>

            <listitem>
              <para>try to ping hosts on the Internet by their IP address, not
              their name. This helps isolate DNS problems. If you can ping by
              address but can't ping by name, then you need to add policy
              rules to permit DNS queries.</para>
            </listitem>

            <listitem>
              <para>Look in firewall's log for records indicating that it
              drops packets. Error in the policy design can cause it to block
              connections that you really want to go through.</para>
            </listitem>

            <listitem>
              <para>Use option "Log everything" to make all rules generate log
              entries, this sometimes helps pinpoint a rule that drops
              packets.</para>
            </listitem>
          </itemizedlist></para>

        <para>Things to check in the policy:</para>

        <para><itemizedlist spacing="compact">
            <listitem>
              <para>Check if you have a NAT rule if your protected network is
              using "private" IP addresses.</para>
            </listitem>

            <listitem>
              <para>If the NAT rule is there, then you may need to add a
              policy rule to actually permit connections from the protect
              network.</para>
            </listitem>

            <listitem>
              <para>In case when NAT is not used, check if the routing is
              configured properly. If your firewall separates subnets A and B,
              and you are trying to connect from the host on subnet A to the
              host on subnet B, then both hosts should have routing to the
              opposite network. Host on the net A needs a route for the net B,
              pointing at the firewall. Similarly, host on the net B needs a
              route for the net A, also pointing at the firewall. If one (or
              both) host has a default route pointing at the firewall, then it
              won't need a special route for another network.</para>
            </listitem>
          </itemizedlist></para>
      </sect2>
    </sect1>


    <sect1 id="problems_with_routing_rules">
      <title>Routing Rules Issues</title>
       <sect2>
	<title>Compile fails with dynamic or point-to-point interfaces</title>

	<para><emphasis>Compile fails with dynamic or point-to-point interfaces</emphasis></para>

	  <para>If you have interfaces with a dynamic address or a
	  point-to-point address and you try to insert a routing rule
	  for the default gateway, compilation might fail, stating
	  "gateway not reachable". Typically this is the case for DSL
	  dial-up links. Solution: leave the gateway field empty.
	  Just specify the interface.</para>
	</sect2>
    </sect1>
  </chapter>
