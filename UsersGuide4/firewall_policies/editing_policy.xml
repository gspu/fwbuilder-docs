      <sect1 id="editing-policy-and-nat">
        <title>Editing Firewall Rule Sets</title>

        <sect2>
          <title>Adding and Removing Rules</title>

          <figure id="editing-policy1">
            <title>Modifying Policy Rules</title>
            <graphic scale="60" fileref="firewall_policies/images/editing_policy1.png" />
          </figure>

          <para>
            Rules can be added, removed, or moved around in the
            policy using commands in a pop-up menu. The menu appears if
            you right-click the rule element "Number" (the very first rule
            element, counting from the left).
            <xref linkend="editing-policy1" /> illustrates this
            menu.
          </para>

          <para>
            This menu allows you to add new rules above or below the
            currently selected rule in the policy, remove rules, move
            the current rule up or down, plus the standard
            <guimenuitem>Copy</guimenuitem>/<guimenuitem>Paste</guimenuitem>
            operations done on policy rules.
          </para>

          <para>
            Functions of this pop-up menu are also duplicated in the
            <guimenu>Rules</guimenu> menu.
          </para>

          <para>
            Items in this menu act on selected rules even when
            several rules are selected.
          </para>

          <para>This menu provides items for the following functions:</para>

          <para>
            <itemizedlist spacing="compact">
              <listitem>
                <para>New Group</para>

                <para>Contiguous rules can be grouped together for
                easier handling. A group of rules can be collapsed in
                the GUI so that only the group name appears. This can
                make it easier to deal with rulesets with many
                rules. The <guimenu>New Group</guimenu> command opens
                a dialog that lets you create and name a new
                group. The current rule is automatically added to the
                group. <xref linkend="using-rule-groups" /> has more
                information on rule groups.</para>
              </listitem>

              <listitem>
                <para>Add to the group</para>

                <para>The selection only appears if you right-click 
                  a rule directly above or below an existing group. If
                selected, the current rule is added to the indicated
                group. <xref linkend="using-rule-groups" /> has more
                information on rule groups.</para>
              </listitem>

              <listitem>
                <para>Remove from the group</para>

                <para>The selection only appears if you right-click
                a rule that is currently in a group. This selection
                removes the rule from the group. If you remove a rule
                from the middle of a group, the group splits into two
                groups, one above and one below the current rule. Both
                groups have the same name as the original
                group. <xref linkend="using-rule-groups" /> has more
                information on rule groups.</para>
              </listitem>
              
              <listitem>
                <para>Change Color</para>

                <para>
                  This menu item allows you to change the color of the
                  rule background. This is a good way to group rules
                  visually by function.
                </para>
              </listitem>

              <listitem>
                <para>Insert Rule</para>

                <para>
                  Inserts new rule above current one.
                </para>
              </listitem>

              <listitem>
                <para>Add Rule Below</para>

                <para>
                  Appends new rule below the current one.
                </para>
              </listitem>

              <listitem>
                <para>Remove Rule</para>

                <para>
                  Removes rule from the rule set.
                </para>
              </listitem>

              <listitem>
                <para>Move Rule Up</para>

                <para>
                  Moves current rule up by one position. Keyboard
                  shortcut is "Ctrl-PgUp" on Linux and Windows or
                  "Cmd-PgUp" on Macintosh. If you select several
                  consecutive rules and use this menu item, all
                  selected rules move together.
                </para>
              </listitem>

              <listitem>
                <para>Move Rule Down</para>

                <para>
                  Moves current rule down by one position. Keyboard
                  shortcut is "Ctrl-PgDown" on Linux and Windows or
                  "Cmd-PgDown" on Macintosh. If you select several
                  consequtive rules and use this menu item, all
                  selected rules move together.
                </para>
              </listitem>

              <listitem>
                <para>Copy Rule</para>

                <para>
                  Copies current rule to the clipboard.
                </para>
              </listitem>

              <listitem>
                <para>Cut Rule</para>

                <para>
                  Copies current rule to the clipboard and removes it
                  from the rule set.
                </para>
              </listitem>

              <listitem>
                <para>Paste Rule Above</para>

                <para>
                  Inserts rule from the clipboard above the current
                  one.
                </para>
              </listitem>

              <listitem>
                <para>Paste Rule Below</para>

                <para>
                  Inserts rule from the clipboard below the current
                  one.
                </para>
              </listitem>

              <listitem>
                <para>Disable Rule</para>

                <para>
                  Marks rule as disabled, this makes policy compiler
                  ignore it.
                </para>
              </listitem>

              <listitem>
                <para>Compile rule</para>

                <para>This menu item compiles selected rule and shows
                the result in the editor panel at the bottom of the
                main window.</para>
              </listitem>

            </itemizedlist>
          </para>

        </sect2>

        <sect2>
          <title>Adding, Removing, and Modifying Objects in Policy and NAT
          Rules</title>

          <para>To add objects to the policy or NAT rule you can either drag
          them from the tree and drop them into the corresponding rule
          element, or use the
          <guimenuitem>Copy</guimenuitem>/<guimenuitem>Paste</guimenuitem>
          operation. Objects can be copied into clipboard both from the tree
          and from another policy rule; in both cases use the pop-up menu or
          main menu <guimenu>Edit</guimenu>.</para>

          <para>Clicking the right mouse button when the cursor is over the rule
          elements "Source","Destination" or "Service" opens a
          context-sensitive pop-up menu ( <xref linkend="editing-policy2" />
          ). The same pop-up menu appears when you do that over the "Original
          Source", "Original Destination", "Original Service", "Translated
          Source", "Translated Destination" and "Translated Service" rule
          elements in the NAT rule.</para>

          <figure id="editing-policy2">
            <title>Modifying Objects in a Policy Rule</title>
            <graphic scale="60" fileref="firewall_policies/images/editing_policy2.png" />
          </figure>

          <para>This menu provides items for the following functions:</para>

          <para>
            <itemizedlist spacing="compact">
              <listitem>
                <para>Edit</para>

                <para>This menu item opens the currently selected
                object in the dialog area.</para>
              </listitem>

              <listitem>
                <para>Copy</para>

                <para>The object is copied into clipboard.</para>
              </listitem>

              <listitem>
                <para>Cut</para>

                <para>The object is copied into clipboard and removed from the
                rule.</para>
              </listitem>

              <listitem>
                <para>Paste</para>

                <para>The object on the clipboard is pasted into the
                field in the the rule. A copy of the object stays on
                the clipboard, so it may be pasted multiple
                times.</para>
              </listitem>

              <listitem>
                <para>Delete</para>

                <para>The object is deleted (actually moved to the
                "Deleted Objects" library).
                  </para>
              </listitem>

              <listitem>
                <para>Where used</para>

                <para>Opens a dialog that shows a list of where the
                rule is used in all rule sets in the current
                firewall. In addition, simply clicking on an object
                puts a red rectangle around that object everywhere it
                occurs in the rule set.</para>
              </listitem>

              <listitem>
                <para>Reveal in tree</para>

                <para>Shows the object in its location in the
                appropriate tree. Simply clicking on the object does
                the same thing.</para>
              </listitem>

              <listitem>
                <para>Negate</para>

                <para>All objects in the selected rule element are negated.
                The rule element "Source" is negated in rule #1 in screenshot
                <xref linkend="editing-policy2" />.</para>
              </listitem>

              <listitem>
                <para>Compile rule</para>

                <para>This menu item compiles selected rule and shows
                the result in the editor panel at the bottom of the
                main window.</para>
              </listitem>
            </itemizedlist>
          </para>
        </sect2>

        <sect2>
          <title>Changing rule action</title>

          <para>Clicking the right mouse button when the cursor is over the
          rule element <guilabel>Action</guilabel> opens a context-sensitive pop-up menu ( <xref
          linkend="editing-policy3" /> ).</para>

          <figure id="editing-policy3">
            <title>Modifying the Action of the Policy Rule</title>
            <graphic scale="50" fileref="firewall_policies/images/editing_policy3.png" />  
          </figure>

          <para>The options for this menu are described in
          <xref linkend="action" />.</para>

        </sect2>

        <sect2 id="changing_direction">
          <title>Changing rule direction</title>

          <para>Clicking the right mouse button when the cursor is
          over the rule element <guilabel>Direction</guilabel> opens a
          context-sensitive pop-up menu (
          <xref linkend="editing-policy4" /> ).</para>

          <figure id="editing-policy4">
            <title>Modifying the Direction of the Policy Rule</title>
            <graphic scale="50" fileref="firewall_policies/images/editing_policy4.png" />
          </figure>

          <para>This menu provides items for the following functions:</para>

          <itemizedlist spacing="compact">
            <listitem>
              <para>Inbound:</para>

              <para>The rule matches packets entering the firewall</para>
            </listitem>

            <listitem>
              <para>Outbound:</para>

              <para>The rule matches packets exiting the firewall</para>
            </listitem>

            <listitem>
              <para>Both:</para>

              <para>The rule matches both entering and exiting packets</para>
            </listitem>
          </itemizedlist>

          <para>
            <xref linkend="direction"/> discusses direction parameter
            in more details.
          </para>

        </sect2>

        <sect2 id="rule-options">
          <title>Changing Rule Options and Logging</title>

          <para>clicking the right mouse button when the cursor is over the
          rule element <guilabel>"Options"</guilabel> opens a context-sensitive pop-up menu (
          <xref linkend="editing-policy5" />. )</para>

          <figure id="editing-policy5">
            <title>Logging and Options in a Policy Rule</title>
                <graphic scale="70" fileref="firewall_policies/images/editing_policy5.png" />
          </figure>

          <para>This menu provides items for the following functions:</para>

          <itemizedlist spacing="compact">
            <listitem>
              <para>Modify Options:</para>

              <para>
                This menu item brings up a dialogue that allows you to
                modify certain options specific to the target firewall
                platform, as in <xref linkend="rule-options1"/>.
                These settings are associated with the current rule
                only. For more information on the options available,
                click <guibutton>Help</guibutton> in the Option
                dialogue.</para>
            </listitem>

            <listitem>
              <para>Turn logging ON:</para>

              <para>Turns logging on for all packets matching this rule. If
              the target firewall platform does not support selective logging
              of packets, this menu item is disabled.</para>
            </listitem>

            <listitem>
              <para>Turn logging OFF:</para>

              <para>Turn logging off for packets matching this rule. If the
              target firewall platform does not support selective logging of
              packets, this menu item is disabled.</para>
            </listitem>
          </itemizedlist>

          <figure id="rule-options1">
            <title>iptables Options Dialog</title>
            <graphic scale="70" fileref="firewall_policies/images/rule-options1.png" />
          </figure>
        </sect2>

        <sect2 id="using-rule-groups">
          <title>Using Rule Groups</title>
          
          <sect3>
            <title>Creating Rule Groups</title>

            <para>If you have a rule set with quite a few rules, it can be
              useful to lump some of them together into rule groups. A rule
              group is a contiguous set of rules that you have grouped
              together and assigned a name to. Once you have a group, you can
              collapse it down visually to save screen real estate, then pop
              it back open when you need to look inside.</para>

            <para>Rule groups <emphasis>only</emphasis> affect how the rules
              are displayed visually. They have <emphasis>no affect</emphasis> 
              on how the rule set is compiled or how it works on the firewall.
             </para>

            <para>Let's look at a simple example of using rule groups.</para>

            <para><xref linkend="rule-group1" /> shows a fragment of a set
              of rules. There are two rules for packets destined for eth0,
              several rules for packets destined for eth1, and a couple rules
              for eth2-destined packets.</para>

            <figure id="rule-group1">
              <title>Rules without Grouping</title>
              <graphic scale="70" fileref="firewall_policies/images/rule-group1.png" />  
            </figure>

            <para>The eth2 rules take up a lot of space, so let's group them
              together. We can then collapse the group so it uses less
              space.</para>

            <para>To create the group, right-click in the rule number
              cell of the first "eth1" rule and
              select <guimenuitem>New group</guimenuitem>. (You don't
              have to click the first rule. Any rule in the group
              will do.)</para>

            <figure id="rule-group2">
              <title>Creating a Group</title>
              <graphic scale="70" fileref="firewall_policies/images/rule-group2.png" />  
            </figure>
            
            <para>A dialog appears. Enter the name of the group. This name
              is for your convenience only, so it can be anything. Here we're
              naming the group after the interface, but a more descriptive
              name can be more useful.</para>

            <figure id="rule-group3">
              <title>Naming a Group</title>
              <graphic scale="70" fileref="firewall_policies/images/rule-group3.png" />  
            </figure>

            <para>Now we have a group with one entry. This doesn't provide
              much value, so let's add other rules to the group. You can add
              as many rules as you want, but they must all be contiguous in
              the rule set.</para>

            <figure id="rule-group4">
              <title>Group with One Entry</title>
              <graphic scale="70" fileref="firewall_policies/images/rule-group4.png" />  
            </figure>

            <para>To add more rules, right-click a rule adjacent to the
              rule in the group, then select <guimenuitem>Add to the group
                eth1</guimenuitem>.</para>

            <figure id="rule-group5">
              <title>Adding a Rule to a Group</title>
              <graphic scale="70" fileref="firewall_policies/images/rule-group5.png" />  
            </figure>

            <para>Do that to the rest of the "eth1" rows, and we now
              have a populated group. You can select several
              consequtive rules and add them to the group at once.</para>

            <figure id="rule-group6">
              <title>A Group of Rules</title>
              <graphic scale="70" fileref="firewall_policies/images/rule-group6.png" />  
            </figure>

            <para>To collapse the group, just click the little minus
              (-) or a triangle icon (depends on the OS and visual
              style) in the upper left of the group.
            </para>

            <figure id="rule-group7">
              <title>Collapsed Group</title>
              <graphic scale="70" fileref="firewall_policies/images/rule-group7.png" />  
            </figure>

            <para>The group now takes up less room on your screen, though it
              has not changed in function.</para>
          </sect3>

      <sect3>
        <title>Modifying Rule Groups</title>

          <para>
            You can modify a rule group after you have created
            it. Options are as follows:
          </para>

          <itemizedlist spacing="compact">
            <listitem>
              <para>Renaming a Group</para>

              <para>
                To rename a group, right-click the group name (or
                anywhere on the gray bar that heads the rule, and
                select <guimenuitem>Rename group</guimenuitem>. Then,
                change the name in the dialog and
                click <guibutton>OK</guibutton>.
              </para>
            </listitem>
            <listitem>
              <para>Add more rules to a group</para>

              <para>
                You can add an existing rule to a group if the rule is
                directly above or below the group. Simply right-click
                the rule and select <guimenuitem>Add to the group
                eth1</guimenuitem>.
              </para>
            </listitem>

            <listitem>
              <para>Remove a rule from a group</para>

              <para>
                To remove a rule from the group while leaving it in
                the rule set, right-click in the number of the rule
                (left-most column) and select <guimenuitem>Remove from
                the group</guimenuitem>. You can only remove the first
                or the last rule in the group. Rules in the middle of
                the group can not be removed from it.
              </para>
            </listitem>

            <listitem>
              <para>Remove a rule completely</para>

              <para>
                You can remove a rule in a group entirely by
                right-clicking the number of the rule (left-most
                column) and selecting <guimenuitem>Remove
                rule</guimenuitem>. This will remove the rule from the
                rule set entirely and works the same regardless of
                whether the rule is a member of a group or not. If you
                want to move the rule to anther part of the rule set,
                select <guimenuitem>Cut rule</guimenuitem> instead,
                and then paste the rule elsewhere.
              </para>
            </listitem>

          </itemizedlist>
      </sect3>
    </sect2>

    <sect2 id="rule-elements">
      <title>Support for Rule Elements and Features on Various Firewalls</title>

      <para>Certain fields in the rules are only available if the target
      firewall platform supports them. For example, the iptables firewall
      provides controls for logging of matched packets, while Cisco PIX does
      not; PIX always logs every packet it drops. Where possible, the policy
      compiler tries to emulate the missing feature. For example,
      OpenBSD PF does not support negation natively, but the policy compiler
      provides a workaround and tries to emulate
      this feature for PF. Another example is policy rules with "Outbound"
      direction. Cisco PIX supports only inbound access lists, so the policy
      compiler emulates outbound Access Lists while generating configuration
      for PIX. <xref linkend="policy-rule-elements" /> represents a list of
      fields in the rules and which firewall platforms support them.
      Information about these fields and features is available for Firewall Builder
      GUI that disables corresponding menu items and hides associated policy
      elements when they are not supported.</para>

      <para>
        <table id="policy-rule-elements" tabstyle='reg_table'>
          <title>Rule Features Available on Different Platforms</title>

          <tgroup cols="11">
            <thead>
              <row>
                <entry>Firewall Platform</entry>

                <entry>Source</entry>

                <entry>Destination</entry>

                <entry>Service</entry>

                <entry>Time Interval</entry>

                <entry>Direction</entry>

                <entry>Action</entry>

                <entry>Logging/ Options</entry>

                <entry>Comment</entry>

                <entry>Negation in Policy rules</entry>

                <entry>Negation in NAT rules</entry>
              </row>
            </thead>

            <tbody>
              <row>
                <entry>iptables</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>
              </row>

              <row>
                <entry>ipfilter</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>-</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>-</entry>
              </row>

              <row>
                <entry>pf</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>-</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>
              </row>

              <row>
                <entry>Cisco PIX</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>-</entry>

                <entry>+</entry>

                <entry>+</entry>

                <entry>-</entry>

                <entry>+</entry>

                <entry>-</entry>

                <entry>-</entry>
              </row>
            </tbody>
          </tgroup>
        </table></para>
    </sect2>

    </sect1>

