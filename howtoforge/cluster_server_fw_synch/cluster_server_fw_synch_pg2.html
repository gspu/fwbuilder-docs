<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Managing a Single Firewall Policy for Multiple Servers with Firewall Builder</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<style type="text/css">
<!--
.command {
    padding: 1em;
    border: 1px dashed #2f6fab;
    color: black;
    background-color: #f9f9f9;
    line-height: 1.1em;
        font-family: Courier New, Courier, mono;
        font-size: 12px;
        font-style: italic;
}

.system {
    color: black;
        font-family: Courier New, Courier, mono;
        font-size: 12px;
        font-style: italic;
}

.highlight {
    color: #FF0000;
  font-family: Georgia, "Times New Roman", Times, serif;
  font-size: 12px;
  text-decoration: underline;
}
-->
</style>
</head>

    <h2>Step 3 - Define cluster policy rules</h2> 

    <p>
    After you create the cluster, the Policy object is automatically 
    opened in the Rules Panel. Make sure to create the rules in 
    the <b>cluster object</b>, called web-servers in our example, and 
    not in one of the individual firewalls that are members of the 
    cluster. Remember we wanted both of our servers to have the 
    following rules:
    </p>

    <ul>
       <li>Allow system to commuicate to its own loopback  
       interface</li>
       <li>Allow inbound HTTP and HTTPS from anywhere to the 
       server</li>
       <li>Allow inbound SSH from a specific set of trusted
       subnets</li>
       <li>Allow outbound connectivity to port 8009 (jboss) 
       to a group of application servers</li>
    </ul>

    <p>
    After you configure these rules in the web-servers Policy 
    object the rules should look like this:
    </p>

    <center>
    <img src="cluster_server_rules.png" alt="cluster policy rules" />
    </center>

    <p>
    <b>NOTE:</b> For objects that are related to the firewall itself, 
    such as interfaces, make sure to use the objects from the cluster when 
    creating the rules. The cluster objects will automatically get 
    translated to the correct object for the individual cluster 
    members.
    </p>

    <h2>Step 4 - Compile and install rules</h2> 

    <p>
    The next step is to compile and install the rules on our servers. 
    When Firewall Builder compiles the cluster it will generate a firewall 
    script for each of the cluster members including substituting the 
    cluster objects used in the rules for the matching local object on 
    the cluster member.
    </p>
    
    <p>
    For example, the IP address for the eth0 cluster object is automatically 
    translated to the correct address for web-01 (192.0.2.11) and web-02 
    (192.0.2.12).
    </p>

    <p>
    You can see this substitution by inspecting the generated file for web-01 
    after the compile is completed. <b>Note</b> that the destination in the 
    rule shown below is set to the IP address of web-01's eth0 interface.
    </p>

    <p class="command">
echo "Rule 0 (eth0)"<br />
#</br />
$IPTABLES -A INPUT -i eth0 -p tcp -m tcp -m multiport \ <br /> -d <b>192.0.2.11 </b> --dports 80,443 
 -m state --state NEW -j ACCEPT
    </p>

    <h2>Modifying rules</h2> 

    <p>
    Now that you have a cluster setup to generate firewall policies for 
    each of the server firewalls it is easy to make changes that affect 
    all your servers. For example, to add a new rule to all members of the 
    web-servers cluster to allow ICMP from the Trusted Networks object to 
    servers simply add the rule in the cluster policy and compile and install 
    it to the members.
    </p>

    <h2>Adding a new server to the cluster</h2> 

    <p>
    To add a new server to the cluster you first need to create the firewall 
    object to represent the server.  You can do this manually, or you can 
    follow the same duplication process we used to create the web-02 
    firewall object. 
    </p>

    <ul>
      <li>Right-click on web-02 firewall and select Duplicate -> place 
      in library User</li>
      <li>Edit the name of the newly created firewall object to web-03
      </li>
      <li>Click on the Host OS Settings and disable IPv4 Packet 
      forwarding
      </li>
      <li>Double-click on web-03's IP object under the eth0 interface 
      and set the IP address to 192.0.2.23 / 24</li>
    </ul>

    <p>
    The next step is to add the new web-03 firewall object to the cluster.
    </p>

    <center>
    <img src="add_server_to_cluster.png" alt="steps to add a new server 
    called web-03 to the cluster" />
    </center>

    <p>
    Repeat this process for the "lo" loopback interface. Remember the steps 
    are:
    </p>

    <ul>
      <li>Double-click on the interface named web-servers:eth0:members
      </li>
      <li>Click on the Manage Members button at the bottom of the 
      Editor Panel</li>
      <li>Click to select the "lo" interface under the web-03 object 
      </li>
      <li>Click the right arrow > button to add the interface to the 
      cluster member list</li>
      <li>Click Ok</li>
    </ul>

    <h2>Installing firewall policy on new server in cluster</h2> 

    <p>
    To deploy the firewall policy on web-03 you need to compile and install 
    the cluster policy. Since the cluster policy hasn't changed we don't need 
    to re-install the policy on web-01 or web-02 so we unselect them from the 
    install list.
    </p>

    <center>
    <img src="web-03_compile_install.png" alt="compiling and installing 
    the cluster policy on web-03" />
    </center>

    <p>
    You can add and remove servers to the cluster as needed. Here's our 
    configuration now that we have three servers in the cluster all 
    running the same firewall rules.
    </p>

    <center>
    <img src="cluster_fw_synch_3_servers.png" alt="web farm with three 
    servers as members of the same cluster" />
    </center>

</body>
</html>
